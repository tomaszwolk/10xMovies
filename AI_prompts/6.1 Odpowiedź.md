Przeanalizuję plik z podsumowaniem planowania bazy danych pod kątem spójności i możliwych uproszczeń dla MVP.

[2 tools called]

Przeanalizuję plik podsumowania pod kątem spójności, niepotrzebnych elementów i możliwości konsolidacji.

## Analiza Podsumowania - Główne Ustalenia

### ✅ **Elementy Spójne i Poprawne**

1. **Struktura główna** - dobrze zdefiniowane encje: users, movies, platforms, watchlist, availability
2. **RLS** - spójna strategia bezpieczeństwa z dostępem przez backend
3. **Partycjonowanie** - logiczne dla tabel z dużą ilością danych
4. **Naturalny PK** `tconst` - dobry wybór dla integracji z IMDb

### ⚠️ **Potencjalne Niespójności**

1. **`search_query` - czy osobna tabela czy typ eventu?**
   - Punkt 14: "logowanie zapytań wyszukiwania (`search_query`)" - sugeruje część `event`
   - Punkt 22 i rozstrzygnięcie 1: traktuje jako osobną partycjonowaną tabelę
   - **W migracji SQL**: osobna tabela partycjonowana
   - **Wniosek**: Niespójność w dokumencie - powinna być wyjaśniona

2. **`users` vs `auth_user`**
   - Podsumowanie używa nazwy `users`
   - Migracja SQL i db-plan używają `auth_user`
   - **Zalecenie**: Ujednolicić nazewnictwo w dokumentacji

### 🔧 **Możliwe Uproszczenia dla MVP**

#### **1. Połączyć `movie_assets` z `movie` ⭐ WAŻNE**
```
Aktualne:
- movie (9 pól)
- movie_assets (2 pola + tconst PK)

Uproszczone:
- movie (11 pól)
```
**Uzasadnienie**: Tylko 2 pola (poster_path, poster_last_checked), relacja 1:1, bez korzyści z osobnej tabeli w MVP.

#### **2. Usunąć `country` i `region_map` w MVP** ⭐
```
Aktualne: 
- country (słownik krajów)
- region_map (mapowanie Watchmode→ISO)

Uproszczone:
- Hardcodować 'PL' w movie_availability
- FK do country.code → zmienić na CHECK (region_code = 'PL')
```
**Uzasadnienie**: MVP tylko Polska, 2 dodatkowe tabele dla 1 wartości to over-engineering.

#### **3. Usunąć `platform_external` w MVP** ⭐
```
Aktualne:
- platform_external (mapowania Watchmode/TMDB→platform.id)

Uproszczone:
- Mapowania w konfiguracji Django (settings.py lub const.py)
```
**Uzasadnienie**: 5 platform × 2 źródła = ~10 rekordów, lepiej w kodzie niż w DB.

#### **4. Rozważyć połączenie `movie_external_ids` z `movie`**
```
Aktualne:
- movie_external_ids (tconst PK, tmdb_id, watchmode_id)

Potencjalnie:
- movie (+ tmdb_id, watchmode_id)
```
**Uzasadnienie**: Relacja 1:1, ale osobna tabela ma sens dla:
- Unikalne indeksy częściowe na NULL
- Separacja danych "czysto IMDb" od integracji
**Zalecenie**: ZOSTAWIĆ jako osobną tabelę (dobra normalizacja).

#### **5. Uprościć `availability_refresh_run`**
```
Aktualne pola:
- started_at, completed_at, status
- movies_checked, movies_updated, errors_count
- error_message

Dla MVP wystarczy:
- started_at, completed_at, status
- movies_updated
```
**Uzasadnienie**: Szczegółowe metryki (movies_checked, errors_count) mogą być logowane do `integration_error_log`.

#### **6. Rozważyć usunięcie `analytics_daily_snapshot` w MVP**
```
Pytanie: Czy w MVP potrzebne są dzienne snapshoty?
- Metryki mogą być liczone on-demand z tabel event/users
- Dodać w wersji 1.1 gdy będzie potrzeba optymalizacji
```
**Zalecenie**: Jeśli nie ma konkretnego wymagania dashboardu analitycznego, **ODŁOŻYĆ**.

#### **7. Rozważyć uproszczenie `mv_movies_in_use`**
```
Pytanie: Czy w MVP potrzebny materializowany widok?
- Używany do priorytetyzacji odświeżania dostępności
- W MVP z małą bazą użytkowników może być query on-demand
```
**Zalecenie**: Jeśli база < 10K filmów w użyciu, **ODŁOŻYĆ** do v1.1.

#### **8. Konsolidacja logów - `event` vs `search_query`**
```
Aktualne:
- event (event_type, properties JSONB)
- search_query (query_text, results_count)

Uproszczone:
- event z typem 'search' i properties: {query, results_count}
```
**Uzasadnienie**: 
- Jedna tabela partycjonowana zamiast dwóch
- Mniej kodu maintenance (partycje, czyszczenie)
- Spójna struktura analytics

---

## 📋 **Konkretne Zalecenia dla Rewizji**

### **Priorytet 1 - Uproszczenia obowiązkowe:**

1. ✅ **Połączyć `movie_assets` → `movie`**
2. ✅ **Usunąć `country` i `region_map`** - hardcodować 'PL'
3. ✅ **Usunąć `platform_external`** - mapowania w kodzie
4. ✅ **Połączyć `search_query` → `event`** - jeden typ eventu

### **Priorytet 2 - Do dyskusji:**

5. ⚠️ **Uprościć `availability_refresh_run`** - mniej metryk
6. ⚠️ **Odłożyć `analytics_daily_snapshot`** - na v1.1?
7. ⚠️ **Odłożyć `mv_movies_in_use`** - na v1.1?

---

## 📝 **Podsumowanie korzyści z uproszczeń:**

### **Przed:**
- 15 tabel głównych + 3 staging = 18 tabel
- 3 tabele partycjonowane
- 2 materializowane widoki/snapshoty

### **Po (Priorytet 1):**
- **11 tabel głównych** + 3 staging = 14 tabel (-22%)
- **2 tabele partycjonowane** (event, integration_error_log)
- **Opcjonalnie 0-1** materializowany widok

### **Korzyści:**
- ⚡ Mniej JOIN-ów (movie_assets w movie)
- 🔧 Prostszy maintenance (mniej partycji)
- 📉 Mniej boilerplate (RLS, triggers, indeksy)
- 🚀 Szybszy development MVP
- 🎯 YAGNI - nie budujemy tego czego nie potrzebujemy

---

Czy chcesz, żebym:
1. **Zaktualizował plik podsumowania** z tymi uproszczeniami?
2. **Zmodyfikował migrację SQL** zgodnie z rekomendacjami?
3. **Stworzył porównanie** przed/po dla konkretnych tabel?