# Kontynuacja: Naprawa AI Suggestions - Filtrowanie dostępnych filmów

## Kontekst
Pracujemy nad aplikacją MyVOD - system rekomendacji filmowych oparty na Gemini AI. Podstawowa integracja działa, ale są problemy z filtrowaniem filmów.

## Tech Stack
- Backend: Django 5.0+ & Django REST Framework
- Database: PostgreSQL 15 (Supabase)
- AI: Google Gemini (`gemini-2.5-flash-lite`)
- Python: 3.11+

## Co działa
- Endpoint `GET /api/suggestions/` zwraca sugestie ✅
- Gemini AI generuje odpowiedzi ✅
- Cache i rate limiting działają ✅
- Custom UUID authentication działa ✅
- Testy przechodzą (28/28) ✅

## KRYTYCZNE PROBLEMY do naprawy:

### Problem 1: Tylko 1/5 filmów jest dostępny na platformie użytkownika
**Dane testowe:**
- User ID: `2489b2a0-9037-44c6-ad71-5a0820fc2280`
- Platformy: Netflix, HBO Max
- Dostępne filmy w bazie: 4119 (w `movie_availability` z `is_available=true`)
- Filmy użytkownika: 1269 (473 watchlist + 796 watched)

**Obecny wynik:**
Gemini zwraca 5 sugestii, ale tylko 1 ma `availability` z platformą. Pozostałe 4 mają `"availability": []`

**Oczekiwany wynik:**
Wszystkie 5 sugestii powinny być dostępne na Netflix lub HBO Max.

### Problem 2: AI twierdzi że filmy są na watchlist, ale ich tam nie ma
**Obecny wynik:**
- Wszystkie 5 filmów mają justification: "This is on your watchlist"
- Sprawdzenie w bazie: żaden z tych filmów nie jest na watchlist użytkownika

**Prompt mówi:**
"At least two suggestions must be outside of their watchlist"

### Problem 3: Możliwe duplikaty w queries - NOTE: sprawdziłem, nie ma duplikatów, jest 1269 pozycji
Zapytania do `user_movie` mogą zwracać duplikaty, sprawdź:
```sql
SELECT tconst, COUNT(*) 
FROM user_movie 
WHERE user_id = '2489b2a0-9037-44c6-ad71-5a0820fc2280'
GROUP BY tconst 
HAVING COUNT(*) > 1;
```

## Kluczowe pliki:

1. **`myVOD/backend/myVOD/services/ai_suggestions_service.py`**
   - Funkcja `_get_available_movies_for_platforms()` - prawdopodobnie źródło problemu
   - Funkcja `_build_gemini_prompt()` - może źle przekazywać dane
   - Funkcja `_validate_suggestions()` - może źle walidować

2. **`myVOD/backend/myVOD/movies/models.py`**
   - Model `MovieAvailability` - struktura danych

## Zadania:

1. **Zdiagnozuj `_get_available_movies_for_platforms()`:**
   - Sprawdź query SQL
   - Zweryfikuj czy filtruje tylko `is_available=true`
   - Sprawdź czy są duplikaty
   - Dodaj debug logging

2. **Popraw prompt w `_build_gemini_prompt()`:**
   - Upewnij się że Gemini dostaje TYLKO dostępne filmy
   - Dodaj wyraźną instrukcję aby wybierać z listy
   - Popraw logikę "2 filmy spoza watchlist"

3. **Ulepsz walidację w `_validate_suggestions()`:**
   - Sprawdź czy sugerowane filmy są faktycznie dostępne
   - Dodaj walidację z `movie_availability`

4. **Debug i testy:**
   - Dodaj logging który pokaże:
     - Ile filmów jest przekazanych do Gemini
     - Które filmy Gemini wybiera
     - Dlaczego availability jest puste

## Rozpocznij od:
Przeczytaj plik `ai_suggestions_service.py` (szczególnie funkcje wymienione wyżej) i zdiagnozuj dlaczego filmy niedostępne są sugerowane.
