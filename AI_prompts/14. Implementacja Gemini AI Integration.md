# Implementacja Gemini AI Integration dla Endpointa GET /api/suggestions/

## ğŸ¯ Cel zadania

ZaimplementowaÄ‡ rzeczywistÄ… integracjÄ™ z Google Gemini AI w endpoincie `GET /api/suggestions/`, zastÄ™pujÄ…c obecne mock data prawdziwymi rekomendacjami filmowymi generowanymi przez AI.

## ğŸ“‹ Kontekst projektu

**Projekt:** MyVOD - aplikacja webowa do zarzÄ…dzania watchlistÄ… filmÃ³w i sprawdzania ich dostÄ™pnoÅ›ci na platformach VOD.

**Tech Stack:**
- Backend: Django 5.0+ & Django REST Framework
- Database: PostgreSQL 15
- Python: 3.11+
- AI: Google Gemini API

## âœ… Co zostaÅ‚o juÅ¼ zrobione

### 1. Endpoint API (w peÅ‚ni zaimplementowany)
- âœ… `GET /api/suggestions/` - endpoint do pobierania sugestii AI
- âœ… PeÅ‚na obsÅ‚uga bÅ‚Ä™dÃ³w (401, 404, 429, 500)
- âœ… Rate limiting (1 request na dzieÅ„)
- âœ… Caching w bazie danych
- âœ… Serializery: `AISuggestionsSerializer`, `SuggestionItemSerializer`, `MovieAvailabilitySerializer`
- âœ… Autentykacja JWT
- âœ… OpenAPI documentation

### 2. Service Layer (`services/ai_suggestions_service.py`)
- âœ… Funkcja `get_or_generate_suggestions(user)` - gÅ‚Ã³wna logika biznesowa
- âœ… Funkcja `_generate_new_suggestions(user, expires_at)` - generowanie nowych sugestii
- âœ… **Mock function**: `_generate_mock_suggestions(user, user_movies)` - **TO WYMAGA ZAMIANY NA PRAWDZIWE WYWOÅANIE GEMINI**
- âœ… Funkcja `_get_movie_availability(tconst, platform_ids)` - sprawdzanie dostÄ™pnoÅ›ci
- âœ… Funkcja `_format_cached_suggestions(user, cached_batch)` - formatowanie cache
- âœ… Funkcja `_log_integration_error(...)` - logowanie bÅ‚Ä™dÃ³w do bazy
- âœ… Custom exceptions: `InsufficientDataError`, `RateLimitError`

### 3. Testy (wszystkie przechodzÄ… - 160/160 âœ…)
- âœ… Unit testy: `services/tests/test_ai_suggestions_service.py` (15 testÃ³w)
- âœ… Integration testy: `myVOD/tests/test_ai_suggestions.py` (12 testÃ³w)
- âœ… **Wszystkie testy uÅ¼ywajÄ… mockÃ³w dla wywoÅ‚ania AI** - po implementacji prawdziwego API naleÅ¼y upewniÄ‡ siÄ™, Å¼e testy nadal dziaÅ‚ajÄ…

## ğŸ“‚ Kluczowe pliki projektu

### 1. GÅ‚Ã³wny plik do modyfikacji
```
myVOD/backend/myVOD/services/ai_suggestions_service.py
```
Funkcja do zastÄ…pienia: `_generate_mock_suggestions(user, user_movies)`

### 2. Modele bazy danych
```
myVOD/backend/myVOD/movies/models.py
```
- `Movie` - filmy z IMDB (tconst, primary_title, start_year, avg_rating, genres, etc.)
- `UserMovie` - filmy uÅ¼ytkownika (watchlisted_at, watched_at, added_from_ai_suggestion)
- `AiSuggestionBatch` - cache sugestii AI (user_id, generated_at, expires_at, prompt, response)
- `IntegrationErrorLog` - logi bÅ‚Ä™dÃ³w integracji

### 3. Serializery
```
myVOD/backend/myVOD/myVOD/serializers.py
```
- `AISuggestionsSerializer` - gÅ‚Ã³wna odpowiedÅº API
- `SuggestionItemSerializer` - pojedyncza sugestia
- `MovieAvailabilitySerializer` - dostÄ™pnoÅ›Ä‡ na platformach

### 4. Testy (do weryfikacji po zmianach)
```
myVOD/backend/myVOD/services/tests/test_ai_suggestions_service.py
myVOD/backend/myVOD/myVOD/tests/test_ai_suggestions.py
```

### 5. Dokumentacja
```
AI_prompts/11.9 Plan implementacji endpointa GET suggestions.md
```
Zawiera kompletnÄ… specyfikacjÄ™ API i wymagania biznesowe.

## ğŸ”§ Co konkretnie trzeba zrobiÄ‡

### Krok 1: Przygotowanie Å›rodowiska
1. Zainstaluj Google Generative AI SDK:
   ```bash
   pip install google-generativeai
   ```
   
2. Dodaj do `.env` (lub `settings.py`):
   ```
   GEMINI_API_KEY=your_api_key_here
   ```

3. Skonfiguruj dostÄ™p do API key w Django settings:
   ```python
   # myVOD/backend/myVOD/myVOD/settings.py
   GEMINI_API_KEY = os.getenv('GEMINI_API_KEY')
   ```

### Krok 2: Implementacja prawdziwej funkcji `_generate_mock_suggestions`

**Lokalizacja:** `myVOD/backend/myVOD/services/ai_suggestions_service.py`

**Obecna implementacja (do zastÄ…pienia):**
```python
def _generate_mock_suggestions(user, user_movies):
    """
    MOCK function - generate movie suggestions.
    This should be replaced with actual AI integration (Gemini API).
    """
    # ... mock code ...
    return [
        {"tconst": "tt0111161", "justification": "..."},
        {"tconst": "tt0137523", "justification": "..."},
        # ...
    ]
```

**Nowa implementacja powinna:**

1. **PrzygotowaÄ‡ kontekst dla AI:**
   - Lista filmÃ³w z watchlisty uÅ¼ytkownika (tytuÅ‚y, gatunki, oceny, lata)
   - Lista obejrzanych filmÃ³w uÅ¼ytkownika
   - Preferencje gatunkowe (na podstawie historii)

2. **ZbudowaÄ‡ prompt dla Gemini:**
   ```
   You are a movie recommendation expert. Based on the user's watched movies and watchlist, 
   suggest 5 movies they might enjoy.
   
   User's Watchlist:
   - [Movie titles, genres, years, ratings]
   
   User's Watched Movies:
   - [Movie titles, genres, years, ratings]
   
   Requirements:
   - Suggest movies from the IMDB database
   - Provide justification for each recommendation (max 200 characters)
   - Return ONLY valid IMDB tconst IDs (format: ttXXXXXXX)
   - Focus on movies similar in genre/theme but not too obvious
   
   Return format (JSON):
   [
     {
       "tconst": "tt0468569",
       "justification": "Epic crime drama with outstanding performances..."
     },
     ...
   ]
   ```

3. **WywoÅ‚aÄ‡ Gemini API:**
   ```python
   import google.generativeai as genai
   from django.conf import settings
   
   genai.configure(api_key=settings.GEMINI_API_KEY)
   model = genai.GenerativeModel('gemini-pro')
   response = model.generate_content(prompt)
   ```

4. **ParsowaÄ‡ odpowiedÅº:**
   - WyciÄ…gnÄ…Ä‡ JSON z odpowiedzi
   - WalidowaÄ‡ strukture
   - SprawdziÄ‡ czy `tconst` istnieje w bazie `Movie`
   - OdfiltrowaÄ‡ nieprawidÅ‚owe sugestie

5. **ObsÅ‚uÅ¼yÄ‡ bÅ‚Ä™dy:**
   - Timeout
   - Invalid API key
   - Rate limiting z Gemini
   - NieprawidÅ‚owa odpowiedÅº (brak JSON, zÅ‚e tconst)
   - LogowaÄ‡ wszystkie bÅ‚Ä™dy do `IntegrationErrorLog`

6. **ZwrÃ³ciÄ‡ listÄ™ sugestii:**
   ```python
   return [
       {"tconst": "tt0468569", "justification": "..."},
       {"tconst": "tt0816692", "justification": "..."},
       # ... max 5 filmÃ³w
   ]
   ```

### Krok 3: Wymagania implementacyjne

**Format odpowiedzi funkcji** (nie zmieniaÄ‡!):
```python
[
    {
        "tconst": str,  # format: ttXXXXXXX
        "justification": str  # max 200 znakÃ³w
    },
    # ... max 5 elementÃ³w
]
```

**Wymagania biznesowe:**
- Maksymalnie 5 sugestii
- KaÅ¼da sugestia musi mieÄ‡ `tconst` istniejÄ…cy w bazie `Movie`
- Uzasadnienie max 200 znakÃ³w
- Sugestie nie powinny zawieraÄ‡ filmÃ³w juÅ¼ na watchliÅ›cie uÅ¼ytkownika
- Sugestie nie powinny zawieraÄ‡ filmÃ³w juÅ¼ obejrzanych (chyba Å¼e sÄ… usuniÄ™te z watchlisty)

**Error handling:**
- Wszystkie bÅ‚Ä™dy z Gemini API powinny byÄ‡ catchowane
- BÅ‚Ä™dy logowaÄ‡ przez `_log_integration_error(api_type="gemini", ...)`
- W przypadku bÅ‚Ä™du API, zwrÃ³ciÄ‡ pustÄ… listÄ™ `[]` (nie crash'owaÄ‡)
- Timeout dla Gemini API: max 30 sekund

**Logging:**
```python
# W przypadku bÅ‚Ä™du:
_log_integration_error(
    api_type="gemini",
    error_message=str(e),
    error_details={
        "prompt_length": len(prompt),
        "user_movies_count": len(user_movies),
        "error_type": type(e).__name__
    },
    user_id=user.id
)
```

### Krok 4: Testowanie

Po implementacji uruchom testy:
```bash
cd myVOD/backend/myVOD
python manage.py test services.tests.test_ai_suggestions_service myVOD.tests.test_ai_suggestions --verbosity 2
```

**Wszystkie 27 testÃ³w muszÄ… przejÅ›Ä‡!**

Testy uÅ¼ywajÄ… mockÃ³w dla wywoÅ‚ania AI, wiÄ™c:
- Upewnij siÄ™, Å¼e nowa funkcja jest odpowiednio zmockowana w testach
- MoÅ¼liwe Å¼e trzeba bÄ™dzie zaktualizowaÄ‡ mocki w testach, jeÅ›li sygnatura funkcji siÄ™ zmieni

### Krok 5: Testowanie manualne

1. UtwÃ³rz uÅ¼ytkownika testowego
2. Dodaj kilka filmÃ³w do watchlisty
3. Oznacz kilka jako obejrzane
4. WywoÅ‚aj endpoint:
   ```bash
   curl -X GET http://localhost:8000/api/suggestions/ \
     -H "Authorization: Bearer YOUR_JWT_TOKEN"
   ```

5. SprawdÅº odpowiedÅº - powinna zawieraÄ‡ prawdziwe sugestie z Gemini

## ğŸ“Š Struktura danych

### Input (user_movies QuerySet):
```python
[
    {
        "id": 1,
        "user_id": UUID("..."),
        "tconst": "tt0816692",
        "tconst__primary_title": "Interstellar",
        "tconst__start_year": 2014,
        "tconst__avg_rating": 8.6,
        "tconst__genres": ["Sci-Fi", "Drama"],
        "watchlisted_at": datetime(...),
        "watched_at": None or datetime(...),
        "watchlist_deleted_at": None
    },
    # ...
]
```

### Expected Output (do zapisu w AiSuggestionBatch.response):
```json
[
    {
        "tconst": "tt0468569",
        "justification": "Epic crime drama with complex narrative and outstanding performances"
    },
    {
        "tconst": "tt1375666",
        "justification": "Mind-bending sci-fi thriller exploring dreams and reality"
    }
]
```

## âš ï¸ WaÅ¼ne uwagi

1. **Nie zmieniaj sygnatury funkcji** `_generate_mock_suggestions(user, user_movies)` - testy polegajÄ… na niej
2. **Nie zmieniaj struktury zwracanej listy** - serializer polega na tym formacie
3. **API key nie moÅ¼e byÄ‡ hardcoded** - uÅ¼ywaj zmiennych Å›rodowiskowych
4. **Rate limiting Gemini** - pamiÄ™taj o limitach API (moÅ¼e byÄ‡ potrzebny retry logic)
5. **Koszty API** - Gemini Pro jest darmowy do pewnego limitu, ale Å›ledÅº usage
6. **Prompt engineering** - moÅ¼esz iterowaÄ‡ nad promptem, aby uzyskaÄ‡ lepsze rezultaty

## ğŸ“ Checklist

- [ ] Zainstalowano `google-generativeai`
- [ ] Skonfigurowano `GEMINI_API_KEY` w settings
- [ ] Zaimplementowano funkcjÄ™ wywoÅ‚ujÄ…cÄ… Gemini API
- [ ] Zbudowano odpowiedni prompt z kontekstem uÅ¼ytkownika
- [ ] Parsowanie i walidacja odpowiedzi Gemini
- [ ] Walidacja `tconst` wzglÄ™dem bazy `Movie`
- [ ] ObsÅ‚uga bÅ‚Ä™dÃ³w i timeout
- [ ] Logowanie bÅ‚Ä™dÃ³w do `IntegrationErrorLog`
- [ ] Wszystkie testy przechodzÄ… (27/27)
- [ ] Testowanie manualne z prawdziwym uÅ¼ytkownikiem
- [ ] Dokumentacja kodu (docstring)

## ğŸ”— Przydatne linki

- Gemini API Documentation: https://ai.google.dev/docs
- Python SDK: https://github.com/google/generative-ai-python
- Prompt Engineering Guide: https://ai.google.dev/docs/prompt_best_practices

## ğŸ’¡ PrzykÅ‚adowy kod (starter)

```python
import google.generativeai as genai
from django.conf import settings
import json
import logging

logger = logging.getLogger(__name__)

def _generate_mock_suggestions(user, user_movies):
    """
    Generate AI-powered movie suggestions using Google Gemini.
    
    Args:
        user: User instance
        user_movies: QuerySet of UserMovie with related Movie data
        
    Returns:
        List of dicts with 'tconst' and 'justification' keys
        
    Raises:
        No exceptions - catches all errors and returns empty list
    """
    try:
        # 1. Configure Gemini
        genai.configure(api_key=settings.GEMINI_API_KEY)
        model = genai.GenerativeModel('gemini-pro')
        
        # 2. Prepare user context
        watchlist = [m for m in user_movies if m.watchlisted_at and not m.watchlist_deleted_at]
        watched = [m for m in user_movies if m.watched_at]
        
        # 3. Build prompt
        prompt = _build_gemini_prompt(watchlist, watched)
        
        # 4. Call Gemini API
        response = model.generate_content(
            prompt,
            generation_config={
                'temperature': 0.7,
                'max_output_tokens': 1000,
            }
        )
        
        # 5. Parse and validate response
        suggestions = _parse_gemini_response(response.text)
        
        # 6. Validate tconst against database
        valid_suggestions = _validate_suggestions(suggestions)
        
        return valid_suggestions[:5]  # Max 5
        
    except Exception as e:
        logger.error(f"Gemini API error: {e}")
        _log_integration_error(
            api_type="gemini",
            error_message=str(e),
            error_details={"error_type": type(e).__name__},
            user_id=user.id
        )
        return []  # Return empty list on error

def _build_gemini_prompt(watchlist, watched):
    """Build prompt for Gemini with user context."""
    # TODO: Implement
    pass

def _parse_gemini_response(response_text):
    """Parse JSON from Gemini response."""
    # TODO: Implement JSON extraction and parsing
    pass

def _validate_suggestions(suggestions):
    """Validate tconst IDs against Movie database."""
    # TODO: Implement validation
    pass
```

---

**Powodzenia z implementacjÄ…! ğŸš€**

